<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>X32 Recorder</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <style>
        body {
            background: #0f172a;
            color: #ffffff;
        }
        .card {
            background: #1f2937;
            border: none;
            border-radius: 14px;
        }
        .action-btn {
            width: 100%;
            height: 50px;
        }
        h3, h5 {
            color: #ffffff;
        }

        .action-btn {
            width: 100%;
            height: 52px;
            font-weight: 500;
        }
        #status {
            color: #ffffff;
            font-size: 16px;
            font-weight: 500;
            line-height: 1.6;
        }
    </style>
</head>

<body>
<div class="container py-4">

    <h3 class="mb-4">üéõ X32 Recorder</h3>

    <!-- STATUS -->
    <div class="card p-3 mb-4">
        <div id="status">Connecting...</div>
    </div>

    <!-- RECORDING -->
    <div class="card p-3 mb-4">
        <h5>Recording</h5>

        <div class="row g-3 mt-1">
            <div class="col-12">
                <button id="recordBtn" class="btn btn-danger action-btn" onclick="toggleRecord()">
                    ‚óè Record
                </button>
            </div>

            <div class="mt-3">
                <small>Time: <span id="recTime">0.0</span>s</small>
            </div>
        </div>
    </div>

    <!-- PLAYBACK + MANAGE -->
    <div class="card p-3">
        <h5>Playback & File Management</h5>

        <select id="fileSelect" class="form-select mb-3"></select>

        <div class="d-flex justify-content-between">
            <small id="curTime">0:00</small>
            <small id="durTime">0:00</small>
        </div>
        
        <input type="range" class="form-range mb-3" id="seekbar" min="0" max="100" value="0">

        <div class="row g-3">
            <div class="col-6">
                <button id="playBtn" class="btn btn-success action-btn" onclick="togglePlay()">‚ñ∂ Play</button>
            </div>
            <div class="col-6">
                <button class="btn btn-secondary action-btn" onclick="stopPlay()">‚ñ† Stop</button>
            </div>
            <div class="col-6">
                <button class="btn btn-warning action-btn" data-bs-toggle="modal" data-bs-target="#renameModal">
                    Rename
                </button>
            </div>
            <div class="col-6">
                <button class="btn btn-outline-danger action-btn" onclick="deleteFile()">
                    Delete
                </button>
            </div>
        </div>
    </div>

</div>

<!-- RENAME MODAL -->
<div class="modal fade" id="renameModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header border-0">
                <h5 class="modal-title">Rename File</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input id="renameInput" class="form-control" placeholder="New filename">
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-warning" onclick="confirmRename()">Rename</button>
            </div>
        </div>
    </div>
</div>



<!-- ERROR MODAL -->
<div class="modal fade" id="errorModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header border-0">
                <h5 class="modal-title text-danger">Error</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p id="errorMessage"></p>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-danger" data-bs-dismiss="modal">
                    OK
                </button>
            </div>
        </div>
    </div>
</div>










<script>
    const socket = io();
    let recording = false;
    let playing = false;
    let duration = 0;
    let position = 0;
    const statusDiv = document.getElementById("status");
    const fileSelect = document.getElementById("fileSelect");
    const renameModal = new bootstrap.Modal(document.getElementById('renameModal'));

    // ---------- SOCKET LISTENERS ----------

    socket.on("status", (data) => {

        recording = !!data.recording;
        playing = !!data.playing;
        duration = data.duration || 0;
        position = data.position || 0;
    
        statusDiv.innerHTML =
            "X32: " + (data.x32 ? "‚úÖ Connected" : "‚ùå Not Found");
    
        // ---- RECORD BUTTON ----
        const recBtn = document.getElementById("recordBtn");
        if (recording) {
            recBtn.classList.remove("btn-danger");
            recBtn.classList.add("btn-dark");
            recBtn.innerText = "‚ñ† Stop Recording";
        } else {
            recBtn.classList.add("btn-danger");
            recBtn.classList.remove("btn-dark");
            recBtn.innerText = "‚óè Record";
        }
    
        document.getElementById("recTime").innerText =
            (data.record_time || 0).toFixed(1);
    
        // ---- PLAY BUTTON ----
        const playBtn = document.getElementById("playBtn");
        if (playing) {
            playBtn.classList.remove("btn-success");
            playBtn.classList.add("btn-warning");
            playBtn.innerText = "‚è∏ Pause";
        } else {
            playBtn.classList.add("btn-success");
            playBtn.classList.remove("btn-warning");
            playBtn.innerText = "‚ñ∂ Play";
        }
    
        // ---- SEEK BAR ----
        const seek = document.getElementById("seekbar");
    
        if (!isSeeking && data.duration > 0) {
            seek.max = data.duration;
            seek.value = data.position;
        }
    
        document.getElementById("curTime").innerText = formatTime(data.position);
        document.getElementById("durTime").innerText = formatTime(data.duration);
    });
    socket.on("position", (data) => {
        if (isSeeking) return;
    
        position = data.position;
        duration = data.duration;
    
        seekbar.max = duration;
        seekbar.value = position;
    
        document.getElementById("curTime").innerText = formatTime(position);
        document.getElementById("durTime").innerText = formatTime(duration);
    });
    
    socket.on("files", (files) => {
        const current = fileSelect.value;
        fileSelect.innerHTML = "";

        files.forEach(f => {
            const opt = document.createElement("option");
            opt.value = f;
            opt.text = f;
            fileSelect.appendChild(opt);
        });

        if (files.includes(current)) fileSelect.value = current;
    });

    // ---------- ACTIONS ----------

    function toggleRecord() {
        if (recording)
            socket.emit("stop_record");
        else
            socket.emit("start_record");
    }
    
    function togglePlay() {
        if (playing)
            socket.emit("stop_play");
        else
            socket.emit("play", {file: fileSelect.value});
    }

    function stopPlay() {
        socket.emit("stop_play");
    }

    function confirmRename() {
        const newName = document.getElementById("renameInput").value;
        if (!newName) return;

        socket.emit("rename", {
            old: fileSelect.value,
            new: newName
        });

        document.getElementById("renameInput").value = "";
        renameModal.hide();
    }

    function deleteFile() {
        if (!confirm("Delete file?")) return;

        socket.emit("delete", {
            file: fileSelect.value
        });
    }

    // ------------ ERROR ACTIONS -----------


    const errorModal = new bootstrap.Modal(document.getElementById('errorModal'));
    const errorMessage = document.getElementById('errorMessage');

    socket.on("app_error", (data) => {
        console.log(' ERROR received:', data);
        showErrorModal(data.msg);
    });

    function showErrorModal(message) {
        errorMessage.textContent = message;
        errorModal.show();
    }
    function toggleRecord() {
        if (recording)
            socket.emit("stop_record");
        else
            socket.emit("start_record");
    }

    function togglePlay() {
        if (playing)
            socket.emit("stop_play");
        else
            socket.emit("play", {file: fileSelect.value});
    }

    const seekbar = document.getElementById("seekbar");

    let isSeeking = false;
    
    seekbar.addEventListener("mousedown", () => isSeeking = true);
    seekbar.addEventListener("touchstart", () => isSeeking = true);
    
    seekbar.addEventListener("mouseup", () => {
        socket.emit("seek", {pos: seekbar.value});
        isSeeking = false;
    });
    
    seekbar.addEventListener("touchend", () => {
        socket.emit("seek", {pos: seekbar.value});
        isSeeking = false;
    });
    
    function formatTime(sec) {
        sec = Math.floor(sec || 0);
        const m = Math.floor(sec / 60);
        const s = sec % 60;
        return `${m}:${s.toString().padStart(2,"0")}`;
    }
</script>

</body>
</html>
